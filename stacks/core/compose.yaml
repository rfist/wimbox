services:
  traefik:
    image: traefik:latest
    restart: unless-stopped
    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=traefik"
      - "--entrypoints.web.address=:80"
      # dashboard optional later; weâ€™ll keep it off for now
      # - "--api.dashboard=true"
    ports:
      - "80:80"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    labels: 
      - "diun.enable=true"
    networks:
      - traefik

  cloudflared:
    image: cloudflare/cloudflared:latest
    restart: unless-stopped
    env_file:
      - .env
    command: tunnel --no-autoupdate run --token ${TUNNEL_TOKEN}
    networks:
      - traefik

  whoami:
    image: traefik/whoami:latest
    restart: unless-stopped
    networks:
      - traefik
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.whoami.rule=Host(`test.${BASE_DOMAIN}`)"
      - "traefik.http.routers.whoami.entrypoints=web"

  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ${APPDATA_ROOT}/portainer:/data
    networks:
      - traefik
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.portainer.rule=Host(`portainer.${BASE_DOMAIN}`)"
      - "traefik.http.routers.portainer.entrypoints=web"
      - "traefik.http.services.portainer.loadbalancer.server.port=9000"
      - "diun.enable=true"

      # FIX CSRF behind Cloudflare Tunnel (HTTPS outside, HTTP inside)
      - "traefik.http.middlewares.portainer-headers.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.routers.portainer.middlewares=portainer-headers"

  diun:
    image: crazymax/diun:latest
    container_name: diun
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - TZ=Europe/Warsaw
      - DIUN_WATCH_SCHEDULE=0 */6 * * *
      - DIUN_WATCH_FIRSTCHECKNOTIF=false
      - DIUN_PROVIDERS_DOCKER=true
      - DIUN_PROVIDERS_DOCKER_WATCHBYDEFAULT=false
      - DIUN_NOTIF_NTFY_ENDPOINT=${DIUN_NOTIF_NTFY_ENDPOINT}
      - DIUN_NOTIF_NTFY_TOPIC=${DIUN_NOTIF_NTFY_TOPIC}
      - DIUN_NOTIF_NTFY_TOKEN=${DIUN_NOTIF_NTFY_TOKEN}

    volumes:
      - ${APPDATA_ROOT}/diun:/data
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - traefik


networks:
  traefik:
    external: true

